<html xmlns:tal="http://xml.zope.org/namespaces/tal"
	xmlns:metal="http://xml.zope.org/namespaces/metal"
	metal:use-macro="here/prefs_main_template/macros/master">

	<body>
	<div id="content" metal:fill-slot="prefs_configlet_content">
		<a href="plone_control_panel">Site Setup</a>
		
		<h1>No Duplicate Login: Max Seats</h1>
		<form action="@@manage-seats" method="post">
			<input id="login" name="login" placeholder="Username" />
			<input type="submit" value="Show Active" />
		</form>

		<hr width="100%" />

		<!-- If there is a login provided, then build the table -->
		<div tal:condition="exists:request/form/login"
			tal:define="login request/form/login | nothing;
				activeTokens view/no_duplicate_login/mapping1/?login/tokens | nothing">
			<div>
				<h3>Listing for user:</h3><span tal:content="login"></span><br/>
				<span tal:condition="exists:view/no_duplicate_login/login_member_data_mapping/?login">
					<!-- The active tokens for login. This does not account for sessions that will have timed out (only those explicitly logged out). -->
					<b>Active Token(s):</b> <span tal:content="python:len(activeTokens) if activeTokens else 0">0</span>

					<!-- The max allowable seats -->
					<b>Max seats:</b> <span tal:define="cached_member_data view/no_duplicate_login/login_member_data_mapping/?login"
						tal:content="python: cached_member_data['maxSeats']"></span>
					<!-- The session timeout in minutes -->
					<b>Session Timeout( min. ):</b> <span tal:define="cached_member_data view/no_duplicate_login/login_member_data_mapping/?login"
						tal:content="python: cached_member_data['seatTimeoutInMinutes']"></span>
				</span>
			</div>

			<!-- List the active tokens.  Some of these may be stale. -->
			<table class="listing">
				<thead>
					<tr>
						<th>Token UID</th><th>Started</th><th>Expires</th><th>Originating IP</th>
					</tr>
				</thead>
				<tbody>
					<tr tal:attributes="class python: 'even' if repeat['token'].index % 2 == 0 else 'odd'" tal:repeat="token activeTokens">
						<div tal:define="tokenInfo view/no_duplicate_login/mapping2/?token | nothing">
							<td tal:content="token">UID</td>
	
							<!-- If tokenInfo exists -->
							<td tal:condition="tokenInfo">
								<span tal:content="tokenInfo/startTime">Started</span>
							</td>
							<td tal:condition="tokenInfo">
								<span tal:content="tokenInfo/expireTime">Expires</span>
							</td>
							<td tal:condition="tokenInfo">
								<span tal:content="tokenInfo/ip">IP Address</span>
							</td>
							<!-- End exists:tokenInfo -->
							
							<!-- If tokenInfo does not exist -->
							<td tal:condition="not:tokenInfo">
								<span>Started</span>
							</td>
							<td tal:condition="not:tokenInfo">
								<span>Expires</span>
							</td>
							<td tal:condition="not:tokenInfo">
								<span>IP Address</span>
							</td>
							<!-- End not:tokenInfo -->
						</div>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	</body>
</html>